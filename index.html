<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Genesys Cloud vCard Sender</title>
  <script type="text/javascript" src="https://sdk-cdn.mypurecloud.com/javascript/181.0.0/purecloud-platform-client-v2.min.js"></script>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .status-section {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }
    
    .button-section {
      margin-top: 20px;
    }
    
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    
    button:hover {
      background-color: #0056b3;
    }
    
    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    
    .log-section {
      margin-top: 20px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      background-color: white;
      border-left: 3px solid #007bff;
      font-family: monospace;
      font-size: 12px;
    }
    
    .error {
      border-left-color: #dc3545;
      color: #dc3545;
    }
    
    .success {
      border-left-color: #28a745;
      color: #28a745;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Genesys Cloud vCard Sender</h1>
    
    <div class="status-section">
      <h3>Status Information</h3>
      <div><strong>User:</strong> <span id="userName">Not logged in</span></div>
      <div><strong>Status:</strong> <span id="userStatus">Unknown</span></div>
      <div><strong>Authentication:</strong> <span id="authStatus">Not authenticated</span></div>
    </div>
    
    <div class="status-section">
      <h3>Conversation Information</h3>
      <div id="conversationInfo">No active conversation detected</div>
    </div>
    
    <div class="button-section">
      <button id="sendVCardBtn" onclick="sendVCard()" disabled>Send vCard</button>
      <button id="refreshBtn" onclick="refreshUserInfo()">Refresh User Info</button>
      <button id="authBtn" onclick="authenticateUser()">Re-authenticate</button>
    </div>
    
    <div class="log-section">
      <h3>Debug Log</h3>
      <div id="logContainer"></div>
    </div>
  </div>

  <script>
    // Configuration - Replace with your actual values
    const config = {
      clientId: "a69fd390-cf52-459b-bdb5-e077e8bf1fdc", // Your client ID
      region: "usw2.pure.cloud", // Your region
      redirectUri: "https://labpeccloud.github.io/vcard.github.io/index.html" // Your exact GitHub Pages URL
    };

    // Global variables
    let genesysClient;
    let me;
    let conversationApi;
    let usersApi;
    let notificationsApi;
    let contentManagementApi;
    let webSocket;
    
    // Variables to store conversation data from notifications
    let v_toaddress = null;
    let v_conversationId = null;
    let v_workspace_id = null;
    let v_sms_from_address = null;

    // Initialize the application
    async function initialize() {
      log("Starting initialization...");
      
      try {
        // Get Genesys SDK reference
        const genesysSDK = window.require('platformClient');
        genesysClient = genesysSDK.ApiClient.instance;
        
        log("Genesys SDK loaded successfully");
        
        // Initialize API instances
        conversationApi = new genesysSDK.ConversationsApi();
        usersApi = new genesysSDK.UsersApi();
        notificationsApi = new genesysSDK.NotificationsApi();
        contentManagementApi = new genesysSDK.ContentManagementApi();
        
        // Set environment
        genesysClient.setEnvironment(config.region);
        log(`Environment set to: ${config.region}`);
        log(`Current URL: ${window.location.href}`);
        log(`Current hash: ${window.location.hash}`);
        
        // Check if we have a hash (token) or need to authenticate
        if (!window.location.hash) {
          log("No token found in URL hash, starting authentication...");
          await authenticateUser();
        } else {
          log("Token found in URL hash, processing authentication...");
          await processAuthToken();
        }
        
      } catch (error) {
        logError("Initialization failed:", error);
      }
    }

    // Authenticate user using implicit grant
    async function authenticateUser() {
      try {
        log(`Starting OAuth with client ID: ${config.clientId}`);
        log(`Redirect URI: ${config.redirectUri}`);
        
        await genesysClient.loginImplicitGrant(config.clientId, config.redirectUri);
        log("Authentication request sent - redirecting...");
        
      } catch (error) {
        logError("Authentication failed:", error);
        document.getElementById("authStatus").innerText = "Authentication failed";
      }
    }

    // Process the authentication token
    async function processAuthToken() {
      try {
        log("Processing authentication token...");
        
        // Try to use loginImplicitGrant which handles the token processing
        await genesysClient.loginImplicitGrant(config.clientId, config.redirectUri);
        
        // Check if authentication was successful
        if (genesysClient.authData && genesysClient.authData.accessToken) {
          log("Authentication token processed successfully!");
          log(`Token expires in: ${genesysClient.authData.tokenExpiryTimeUtcSeconds}`);
          logSuccess("User authenticated successfully");
          document.getElementById("authStatus").innerText = "Authenticated";
          
          // Process conversation notifications
    function processConversationNotification(data) {
      try {
        log("Processing conversation notification...");
        log(`Notification data:`, data);
        
        if (data.eventBody && data.eventBody.participants) {
          // Store conversation ID
          if (data.eventBody.id) {
            v_conversationId = data.eventBody.id;
            log(`Stored conversation ID: ${v_conversationId}`);
          }
          
          // Find customer participant
          const customerParticipant = data.eventBody.participants.find(p => p.purpose === 'customer');
          
          if (customerParticipant) {
            log("Found customer participant:", customerParticipant);
            
            // 1. Get customer address
            if (customerParticipant.address) {
              v_toaddress = customerParticipant.address;
              log(`Stored customer address: ${v_toaddress}`);
            }
            
            // 3. Get attributes from customer participant
            if (customerParticipant.attributes) {
              log("Processing customer attributes:", customerParticipant.attributes);
              
              if (customerParticipant.attributes.workspace_id) {
                v_workspace_id = customerParticipant.attributes.workspace_id;
                log(`Stored workspace ID: ${v_workspace_id}`);
              }
              
              if (customerParticipant.attributes.sms_from_address) {
                v_sms_from_address = customerParticipant.attributes.sms_from_address;
                log(`Stored SMS from address: ${v_sms_from_address}`);
              }
            } else {
              log("No attributes found in customer participant");
            }
            
            // Update UI with conversation info
            updateConversationInfo();
            
          } else {
            log("No customer participant found in conversation");
          }
        } else {
          log("No participants found in notification event body");
        }
        
      } catch (error) {
        logError("Error processing conversation notification:", error);
      }
    }

    // Update UI with conversation information
    function updateConversationInfo() {
      const conversationInfo = document.getElementById("conversationInfo");
      if (conversationInfo) {
        conversationInfo.innerHTML = `
          <strong>Active Conversation:</strong><br>
          ID: ${v_conversationId || 'None'}<br>
          Customer: ${v_toaddress || 'None'}<br>
          Workspace ID: ${v_workspace_id || 'None'}<br>
          SMS From: ${v_sms_from_address || 'None'}
        `;
      }
    }
          await getUserInfo();
          
          // Subscribe to notifications
          await subscribeToNotifications();
          
          // Enable the send vCard button
          document.getElementById("sendVCardBtn").disabled = false;
          
        } else {
          // Try manual token extraction as fallback
          log("SDK didn't process token automatically, trying manual extraction...");
          await extractTokenManually();
        }
        
      } catch (error) {
        logError("Token processing failed:", error);
        log("Attempting manual token extraction...");
        await extractTokenManually();
      }
    }

    // Extract token manually from URL hash
    async function extractTokenManually() {
      try {
        const token = getParameterByName("access_token");
        const expiresIn = getParameterByName("expires_in");
        
        if (token) {
          log(`Manual token extraction successful. Token: ${token.substring(0, 20)}...`);
          log(`Token expires in: ${expiresIn} seconds`);
          
          // Set the token manually
          genesysClient.setAccessToken(token);
          
          logSuccess("Token set manually");
          document.getElementById("authStatus").innerText = "Authenticated (Manual)";
          
          // Get user information
          await getUserInfo();
          
          // Subscribe to notifications
          await subscribeToNotifications();
          
          // Enable the send vCard button
          document.getElementById("sendVCardBtn").disabled = false;
          
        } else {
          throw new Error("No access token found in URL hash");
        }
        
      } catch (error) {
        logError("Manual token extraction failed:", error);
        document.getElementById("authStatus").innerText = "Authentication failed";
      }
    }

    // Helper function to extract parameters from URL hash
    function getParameterByName(name) {
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      let regex = new RegExp("[\\#&]" + name + "=([^&#]*)");
      let results = regex.exec(location.hash);
      return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    // Get user information
    async function getUserInfo() {
      try {
        log("Fetching user information...");
        
        me = await usersApi.getUsersMe({ expand: "presence" });
        
        log(`User info retrieved: ${me.name} (ID: ${me.id})`);
        
        // Update UI
        document.getElementById("userName").innerText = me.name;
        document.getElementById("userStatus").innerText = me.presence.presenceDefinition.systemPresence;
        
        logSuccess(`Logged in as: ${me.name}`);
        
      } catch (error) {
        logError("Failed to get user info:", error);
      }
    }

    // Subscribe to notifications
    async function subscribeToNotifications() {
      try {
        log("Setting up notification subscription...");
        
        if (!me) {
          log("No user info available, skipping notifications");
          return;
        }
        
        // Get or create notification channel
        const channels = await notificationsApi.getNotificationsChannels({});
        let channel;
        
        if (!channels || !channels.entities || channels.entities.length === 0) {
          log("Creating new notification channel...");
          channel = await notificationsApi.postNotificationsChannels();
        } else {
          log("Using existing notification channel...");
          channel = channels.entities[channels.entities.length - 1];
        }
        
        // Create websocket connection
        log(`Connecting to websocket: ${channel.connectUri}`);
        webSocket = new WebSocket(channel.connectUri);
        
        webSocket.onopen = function(event) {
          log("Websocket connection opened");
          logSuccess("Notification system connected");
        };
        
        webSocket.onmessage = function(event) {
          const data = JSON.parse(event.data);
          if (data.topicName !== 'channel.metadata') {
            log(`Notification received: ${data.topicName}`);
            
            // Process conversation notifications
            if (data.topicName && data.topicName.includes('conversations')) {
              processConversationNotification(data);
            }
          }
        };
        
        webSocket.onerror = function(event) {
          logError("Websocket error:", event);
        };
        
        // Subscribe to user presence and conversation topics
        const topics = [
          `v2.users.${me.id}.presence`,
          `v2.users.${me.id}.conversations`
        ];
        
        await notificationsApi.postNotificationsChannelSubscriptions(channel.id, topics);
        log("Subscribed to notification topics");
        
      } catch (error) {
        logError("Failed to setup notifications:", error);
      }
    }

    // Create messaging conversation
    async function createMessagingConversation(toAddress, fromAddress) {
      try {
        log("Creating messaging conversation...");
        
        const body = {
          toAddress: toAddress,
          fromAddress: fromAddress,
          toAddressMessengerType: "sms", // or "open" for other messaging types
          textBody: "Test message from Genesys Cloud vCard sender"
        };
        
        log(`Creating conversation with body:`, body);
        
        const conversation = await conversationApi.postConversationsMessages(body);
        
        log(`Conversation created successfully: ${conversation.id}`);
        logSuccess(`Messaging conversation created: ${conversation.id}`);
        
        return conversation;
        
      } catch (error) {
        logError("Failed to create messaging conversation:", error);
        throw error;
      }
    }

    // Generate vCard and upload to content management
    async function generateVCard() {
      if (!me) {
        logError("No user information available for vCard generation");
        return null;
      }
      
      try {
        log("Starting vCard generation process...");
        
        // Generate vCard content
        const vcard = `BEGIN:VCARD
VERSION:3.0
FN:${me.name}
N:${me.name};;;;
ORG:${me.department || 'Organization'}
TITLE:${me.title || 'Agent'}
EMAIL:${me.email || ''}
TEL:${me.phoneNumber || ''}
END:VCARD`;
        
        log("vCard content generated:");
        log(vcard);
        
        // Check if we have workspace_id from conversation
        if (!v_workspace_id) {
          logError("No workspace ID available. Make sure you're in an active conversation.");
          return null;
        }
        
        log(`Using workspace ID: ${v_workspace_id}`);
        
        // Upload vCard to content management
        const documentResult = await uploadVCardToWorkspace(vcard);
        
        if (documentResult) {
          logSuccess("vCard generated and uploaded successfully!");
          return documentResult;
        } else {
          logError("Failed to upload vCard to workspace");
          return null;
        }
        
      } catch (error) {
        logError("Error in vCard generation process:", error);
        return null;
      }
    }

    // Upload vCard to content management workspace
    async function uploadVCardToWorkspace(vcardContent) {
      try {
        log("Step 1: Preparing vCard file for upload...");
        
        // Create filename with timestamp
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `agent-${me.name.replace(/\s+/g, '_')}-${timestamp}.vcf`;
        
        log(`Generated filename: ${filename}`);
        
        // Convert vCard content to blob
        const blob = new Blob([vcardContent], { type: 'text/vcard' });
        log(`Blob created with size: ${blob.size} bytes`);
        
        // Step 2: Create document in workspace
        log("Step 2: Creating document in workspace...");
        
        const createDocumentBody = {
          name: filename,
          workspace: {
            id: v_workspace_id
          },
          filename: filename,
          contentType: 'text/vcard'
        };
        
        log("Document creation request body:", createDocumentBody);
        
        const document = await contentManagementApi.postContentmanagementDocuments(createDocumentBody);
        
        log("Step 3: Document created successfully!");
        log(`Document ID: ${document.id}`);
        log(`Upload URL: ${document.uploadDestinationUri}`);
        
        // Step 4: Upload file content to the provided URL
        log("Step 4: Uploading vCard content to document...");
        
        const uploadResponse = await fetch(document.uploadDestinationUri, {
          method: 'PUT',
          body: blob,
          headers: {
            'Content-Type': 'text/vcard'
          }
        });
        
        if (!uploadResponse.ok) {
          throw new Error(`Upload failed with status: ${uploadResponse.status}`);
        }
        
        log("Step 5: File content uploaded successfully!");
        
        // Step 6: Monitor upload status
        log("Step 6: Monitoring upload status...");
        
        const finalDocument = await monitorUploadStatus(document.id);
        
        if (finalDocument) {
          // Step 7: Get sharing URI
          log("Step 7: Retrieving document sharing URI...");
          const documentDetails = await contentManagementApi.getContentmanagementDocument(finalDocument.id);
          
          log("Document upload completed successfully!");
          log(`Final Document ID: ${documentDetails.id}`);
          log(`Sharing URI: ${documentDetails.sharingUri || 'Not available'}`);
          
          logSuccess(`vCard uploaded! Document ID: ${documentDetails.id}`);
          
          return {
            documentId: documentDetails.id,
            sharingUri: documentDetails.sharingUri,
            filename: filename
          };
        }
        
        return null;
        
      } catch (error) {
        logError("Error uploading vCard to workspace:", error);
        return null;
      }
    }

    // Monitor upload status
    async function monitorUploadStatus(documentId, maxRetries = 10) {
      try {
        log(`Monitoring upload status for document ID: ${documentId}`);
        
        for (let i = 0; i < maxRetries; i++) {
          log(`Status check attempt ${i + 1}/${maxRetries}...`);
          
          const document = await contentManagementApi.getContentmanagementDocument(documentId);
          
          log(`Current upload status: ${document.uploadStatus?.status || 'Unknown'}`);
          
          if (document.uploadStatus?.status === 'UPLOAD_SUCCESS') {
            logSuccess("Upload completed successfully!");
            return document;
          } else if (document.uploadStatus?.status === 'UPLOAD_FAILED') {
            logError("Upload failed!");
            return null;
          }
          
          // Wait 2 seconds before next check
          log("Waiting 2 seconds before next status check...");
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
        
        logError("Upload status monitoring timed out");
        return null;
        
      } catch (error) {
        logError("Error monitoring upload status:", error);
        return null;
      }
    }

    // Main function to send vCard
    async function sendVCard() {
      try {
        log("Send vCard button clicked");
        
        if (!me) {
          logError("User not authenticated");
          return;
        }
        
        // Check if we have conversation data from notifications
        if (!v_conversationId || !v_toaddress) {
          logError("No active conversation detected. Please ensure you're in an active conversation with a customer.");
          return;
        }
        
        log(`Using conversation data from notifications:`);
        log(`- Conversation ID: ${v_conversationId}`);
        log(`- Customer address: ${v_toaddress}`);
        log(`- Workspace ID: ${v_workspace_id}`);
        log(`- SMS from address: ${v_sms_from_address}`);
        
        // Generate vCard and upload to workspace
        const vcardResult = await generateVCard();
        if (!vcardResult) {
          logError("Failed to generate and upload vCard");
          return;
        }
        
        logSuccess("vCard process completed successfully!");
        log(`Document ID: ${vcardResult.documentId}`);
        log(`Sharing URI: ${vcardResult.sharingUri}`);
        
        // TODO: In next iteration, we can send the sharing URI via SMS
        log("Next step: Send sharing URI via SMS to customer");
        
      } catch (error) {
        logError("Failed to send vCard:", error);
      }
    }

    // Refresh user information
    async function refreshUserInfo() {
      log("Refreshing user information...");
      
      // Check if we have a valid token first
      if (!genesysClient.authData || !genesysClient.authData.accessToken) {
        log("No valid token found, checking URL hash...");
        
        if (window.location.hash) {
          await processAuthToken();
        } else {
          logError("No authentication token available. Please authenticate first.");
          document.getElementById("authStatus").innerText = "Not authenticated";
          return;
        }
      }
      
      await getUserInfo();
    }

    // Logging functions
    function log(message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      
      console.log(logEntry, data || '');
      
      const logContainer = document.getElementById("logContainer");
      const logDiv = document.createElement("div");
      logDiv.className = "log-entry";
      logDiv.textContent = logEntry + (data ? ` ${JSON.stringify(data)}` : '');
      
      logContainer.appendChild(logDiv);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function logError(message, error = null) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ERROR: ${message}`;
      
      console.error(logEntry, error || '');
      
      const logContainer = document.getElementById("logContainer");
      const logDiv = document.createElement("div");
      logDiv.className = "log-entry error";
      logDiv.textContent = logEntry + (error ? ` ${error.message || JSON.stringify(error)}` : '');
      
      logContainer.appendChild(logDiv);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function logSuccess(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] SUCCESS: ${message}`;
      
      console.log(logEntry);
      
      const logContainer = document.getElementById("logContainer");
      const logDiv = document.createElement("div");
      logDiv.className = "log-entry success";
      logDiv.textContent = logEntry;
      
      logContainer.appendChild(logDiv);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // Initialize when page loads
    window.onload = initialize;
  </script>
</body>

</html>
